name: Build, Test, Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Environment where to deploy the stack (dev, staging)
        type: environment
        required: true
  workflow_call:
    inputs:
      environment:
        description: Environment where to deploy the stack (dev, staging)
        type: string
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  build-test-deploy:
    name: Build, test and deploy ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
      - name: Build
        run: |
          npm install
          npm run build
      - name: Test
        run: |
          npm run test
      - name: Prepare deploy artifacts
        run: |
          npm run predeploy
      - name: Configure AWS credentials
        uses: Virtual-Finland-Development/infrastructure/.github/actions/configure-aws-credentials@main
        with:
          environment: ${{ inputs.environment }}
          aws-region: ${{ secrets.AWS_REGION }}
          pulumi-access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - name: Deploy with Pulumi
        id: pulumi
        uses: pulumi/actions@v4
        with:
          work-dir: ./infra
          command: up
          stack-name: virtualfinland/${{ inputs.environment }}
          upsert: true
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - name: Tag the deployment
        uses: Virtual-Finland-Development/automatic-release-action@v1.0
        if: ${{ inputs.environment == 'staging' }}
        with:
          environment: ${{ inputs.environment }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
  deploy-web:
    name: Update demo app
    runs-on: ubuntu-latest
    needs: build-test-deploy
    steps:
      - uses: actions/checkout@v3
      - name: Retrieve authentigation-gw endpoint url from Pulumi
        uses: Virtual-Finland-Development/pulumi-outputs-action@v1
        id: authentigation-gw-endpoint
        with:
          organization: virtualfinland
          project: authentigation-gw
          stack: ${{ inputs.environment }}
          resource: endpoint
          access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - name: Retrieve testbed-api endpoint url from Pulumi
        uses: Virtual-Finland-Development/pulumi-outputs-action@v1
        id: testbed-api-endpoint
        with:
          organization: virtualfinland
          project: authentigation-gw
          stack: ${{ inputs.environment }}
          resource: testbedApiEndpoint
          access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - name: Build the svelte app
        working-directory: ./webapps/svelte
        run: |
          npm install
          npm run build -- --base=/${{ inputs.environment }}
        env:
          VITE_AUTHGW_API_URL: ${{ steps.authentigation-gw-endpoint.outputs.resource-output }}
          VITE_TESTBED_API_URL: ${{ steps.testbed-api-endpoint.outputs.resource-output }}
      - name: Configure AWS credentials
        uses: Virtual-Finland-Development/infrastructure/.github/actions/configure-aws-credentials@main
        with:
          environment: ${{ inputs.environment }}
          aws-region: ${{ secrets.AWS_REGION }}
          pulumi-access-token: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      - name: Deploy Svelte-app to S3
        uses: keithweaver/aws-s3-github-action@v1.0.0
        with:
          command: sync
          source: ./webapps/svelte/dist
          destination: s3://virtual-finland-development-auth-files/${{ inputs.environment }}
          flags: --delete --exclude '.well-known/*'
      - name: Deploy the bucket root redirects to S3
        uses: keithweaver/aws-s3-github-action@v1.0.0
        with:
          command: sync
          source: ./webapps/bucket-root
          destination: s3://virtual-finland-development-auth-files/
