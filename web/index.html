<!DOCTYPE html>
<html>

<body>

    <h1>Virtual Finland Development</h1>

    <h2>Login flow examples / tests</h2>

    <div id="Sinuna">
        <div>
            <b>Sinuna login state:</b> <span class="loginState">...</span>
        </div>
        <hr>
        <div>
            <button class="login" disabled="disabled" onclick="sinuna.AuthService.login()">Login</button>
            <button class="logout" disabled="disabled" onclick="sinuna.AuthService.logout()">Logout</button>
        </div>
    </div>

    <div id="SuomiFI">
        <div>
            <b>Suomi.fi login state:</b> <span class="loginState">...</span>
        </div>
        <hr>
        <div>
            <button class="login" disabled="disabled" onclick="suomifi.AuthService.login()">Login</button>
            <button class="logout" disabled="disabled" onclick="suomifi.AuthService.logout()">Logout</button>
        </div>
    </div>

    <div id="Testbed">
        <div>
            <b>Testbed login state:</b> <span class="loginState">...</span>
        </div>
        <hr>
        <div>
            <button class="login" disabled="disabled" onclick="testbed.AuthService.login()">Login</button>
            <button class="logout" disabled="disabled" onclick="testbed.AuthService.logout()">Logout</button>
        </div>
    </div>

</body>

<script>

    /**************************************************************************
     * 
     * App, services
     * 
    /**************************************************************************/
    const AppSettings = {
        appName: "authflow-test",
        authAPIHost: "", // the authentication gw host
        authResponseHandlerUrl: window.location.origin + window.location.pathname, // the url without query params etc
        generateAppContext() {
            return encodeURIComponent(btoa(JSON.stringify({ appName: this.appName, redirectUrl: this.authResponseHandlerUrl })));
        },
        validateAppSettings() {
            if (!this.authAPIHost) {
                const errorMessage = "AppSettings.authAPIHost is not defined";
                window.alert(errorMessage);
                throw new Error(errorMessage);
            }
        }
    }

    const log = function (context, message, ...args) {
        console.log(context, "->", message, ...args);
    }

    const slashTrim = function (str) {
        return str.replace(/^\/+|\/+$/g, '');
    }

    /**************************************************************************
     * 
     * Login service defs
     * 
    /**************************************************************************/
    class BaseAppComponent {
        parent = null;
        constructor(parent) {
            this.parent = parent;
            this.getName = this.parent.getName.bind(parent);
            this.log = this.parent.log.bind(parent);
            this.endpoints = this.parent.endpoints;
        }

        initialize() {
            this.UIState = this.parent.UIState;
            this.AuthState = this.parent.AuthState;
            this.AuthService = this.parent.AuthService;
        }
    }


    class BaseLoginApp {
        name = null;
        endpoints = null;

        constructor(configuration) {
            this.name = configuration.name;
            this.initializeEndpoints(configuration.name, configuration.authProtocol);

            this.UIState = new UIState(this);
            this.AuthState = new AuthState(this);
            this.AuthService = new AuthService(this);
        }

        initializeEndpoints(providerName, authProtocol) {
            const provider = providerName.toLowerCase();
            const protocol = authProtocol.toLowerCase();
            const authAPIHost = AppSettings.authAPIHost;

            this.endpoints = {
                login: null,
                logout: null,
                userInfo: null,
                token: null,
            }

            switch (protocol) {
                case "openid":
                    this.endpoints.login = `${authAPIHost}/auth/openid/${provider}/login-request`;
                    this.endpoints.logout = `${authAPIHost}/auth/openid/${provider}/logout-request`;
                    this.endpoints.userInfo = `${authAPIHost}/auth/openid/${provider}/user-info-request`;
                    this.endpoints.token = `${authAPIHost}/auth/openid/${provider}/auth-token-request`;
                    break;
                case "saml2":
                    this.endpoints.login = `${authAPIHost}/auth/saml2/${provider}/login-request`;
                    this.endpoints.logout = `${authAPIHost}/auth/saml2/${provider}/logout-request`;
                    this.endpoints.userInfo = `${authAPIHost}/auth/saml2/${provider}/user-info-request`;
                    break;
                default:
                    throw new Error(`Unknown auth protocol: ${protocol}`);
            }
        }


        initialize() {
            this.UIState.initialize();
            this.AuthState.initialize();
            this.AuthService.initialize();
        }

        getName() {
            if (!this.name) {
                throw new Error("name is not defined");
            }
            return this.name;
        }

        log(...messages) {
            log(`[${this.getName()}]`, ...messages);
        }

        engage() {
            this.initialize();
            this.UIState.handleCurrentState();
            this.engageLoginFlowEventsListener();
        }

        /**************************************************************************
          * 
          * Event listeners
          * 
         /**************************************************************************/
        async engageLoginFlowEventsListener() {
            const urlParams = new URLSearchParams(window.location.search);

            const affectsThisApp = urlParams.has("provider") && urlParams.get("provider").toLowerCase() === this.getName().toLowerCase();
            if (!this.AuthState.isLoggedIn()) {
                if (affectsThisApp && urlParams.has("loginCode")) {
                    this.log("LoginFlowEventsListener", "Login code received, fetching auth token..");
                    //
                    // Handle login response
                    //
                    const loginCode = urlParams.get('loginCode');
                    try {
                        const tokens = await this.AuthService.fetchAuthTokens(loginCode);
                        this.AuthState.login(tokens); // Store token in local storage
                        await this.AuthState.handleLoggedIn(); // Fetch user info
                        this.UIState.resetViewState(); // reset view state
                    } catch (error) {
                        this.log("LoginFlowEventsListener", "Failed to fetch auth token", error);
                    }
                }
            } else if (affectsThisApp && urlParams.has("logout")) {
                this.log("LoginFlowEventsListener", "Logout event received, logging out");
                //
                // Handle logout response
                //
                const logoutResponse = urlParams.get('logout');
                if (logoutResponse === "success") {
                    this.AuthState.logout();
                    this.UIState.resetViewState(); // reset view state
                }
            } else {
                await this.AuthState.handleLoggedIn(); // Validate login
                this.UIState.handleCurrentState(); // Update UI
            }
        }
    }

    class AuthService extends BaseAppComponent {
        login() {
            this.log("AuthService", "logging in..");
            AppSettings.validateAppSettings();
            this.UIState.transitToUrl(`${this.endpoints.LoginRequest}?appContext=${AppSettings.generateAppContext()}`);
        }
        async fetchAuthTokens(loginCode) {
            if (typeof this.endpoints.AuthTokenRequest !== "string") {
                // No token endpoint defined, login code is the token
                return { token: loginCode };
            }
            
            const response = await fetch(`${this.endpoints.AuthTokenRequest}`, {
                method: "POST",
                credentials: 'include',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    loginCode: loginCode,
                    appContext: AppSettings.generateAppContext(),
                }),
            });

            const data = await response.json();
            return { token: data.token, idToken: data.idToken }
        }
        async fetchUserInfo(accessToken) {
            const response = await fetch(`${this.endpoints.UserInfoRequest}`, {
                method: "POST",
                credentials: 'include',
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    token: accessToken,
                    appContext: AppSettings.generateAppContext(),
                }),
            });
            if (response.status !== 200) {
                if (response.status === 401) {
                    throw new Error("Unauthorized");
                }
                throw new Error("Unknown error");
            }
            return await response.json()
        }
        logout() {
            this.log("AuthService", "logging out..");
            AppSettings.validateAppSettings();

            const urlParams = new URLSearchParams({
                appContext: AppSettings.generateAppContext(),
            });

            const { idToken } = this.AuthState.getAuthTokens();

            if (idToken) {
                urlParams.append("idToken", idToken);
            }
            
            this.UIState.transitToUrl(`${this.endpoints.LogoutRequest}?${urlParams.toString()}`);
        }
    }

    class AuthState extends BaseAppComponent {
        storeKey = null
        isInTransition = false
        user = {
            email: null,
        }

        constructor(loginApp) {
            super(loginApp);
            this.storeKey = `${AppSettings.appName}_${loginApp.getName()}_authState`;
        }

        login(tokens) {
            this.isInTransition = true;
            if (typeof tokens === "object" && tokens !== null) {
                if (typeof tokens.token === "string") {
                    this.log("AuthState", "logged in");
                    if (typeof tokens.idToken === "string") {
                        this.log("AuthState", "--> Id Token received");
                    }
                    localStorage.setItem(this.storeKey, JSON.stringify(tokens));
                } else {
                    throw new Error("Invalid token response")
                }
            } else {
                throw new Error("Invalid tokens")
            }
        }
        logout() {
            this.isInTransition = true;
            this.user.email = null;
            this.log("AuthState", "logged out");
            localStorage.removeItem(this.storeKey);
        }
        isLoggedIn() {
            return this.getAuthTokens() !== null;
        }
        isLoading() {
            return this.isInTransition || (this.isLoggedIn() && this.user.email === null);
        }
        getAuthTokens() {
            try {
                return JSON.parse(localStorage.getItem(this.storeKey));
            } catch (error) { }
            return null;
        }
        async handleLoggedIn() {
            try {
                const tokens = this.getAuthTokens();
                const userInfo = await this.AuthService.fetchUserInfo(tokens.token);
                this.user.email = userInfo.email;
            } catch (error) {
                // Auth invalidated
                this.log("AuthState", "login invalidated");
                this.logout();
                this.UIState.resetViewState(); // reset view state
            }
        }
    }

    class UIState extends BaseAppComponent {
        handleCurrentState() {
            const loginButton = document.querySelector(`#${this.getName()} .login`);
            const logoutButton = document.querySelector(`#${this.getName()} .logout`);
            const loginState = document.querySelector(`#${this.getName()} .loginState`);
            if (this.AuthState.isLoading()) {
                loginButton.disabled = true;
                logoutButton.disabled = true;
                loginState.innerText = "loading..";
            } else if (this.AuthState.isLoggedIn()) {
                loginButton.disabled = true;
                logoutButton.disabled = false;
                loginState.innerText = this.AuthState.user.email ? `logged in as ${this.AuthState.user.email}` : "logged in";
            } else {
                loginButton.disabled = false;
                logoutButton.disabled = true;
                loginState.innerText = "logged out";
            }
        }
        flagTransition() {
            this.AuthState.isInTransition = true;
            this.handleCurrentState();
        }
        transitToUrl(url) {
            this.flagTransition();
            window.location.href = url;
        }
        resetViewState() {
            window.history.replaceState({}, document.title, window.location.pathname); // clear url params
            this.AuthState.isInTransition = false;
            this.handleCurrentState();
        }
    }

    /**************************************************************************
     * 
     * login services
     * 
    /**************************************************************************/
    const sinuna = new BaseLoginApp({
        name: "Sinuna",
        authProtocol: "openid",
    });
    const suomifi = new BaseLoginApp({
        name: "SuomiFI",
        authProtocol: "saml2",
    });
    const testbed = new BaseLoginApp({
        name: "Testbed",
        authProtocol: "openid",
    });
    /**************************************************************************
     * 
     * Execution
     * 
    /**************************************************************************/
    sinuna.engage();
    suomifi.engage();
    testbed.engage();
</script>

</html>