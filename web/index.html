<!DOCTYPE html>
<html>

<body>

    <h1>Virtual Finland Development</h1>

    <h2>Login flow example / test</h2>

    <div>
        <b>Login state:</b> <span id="loginState">...</span>
    </div>
    <hr>
    <div>
        <button id="login" disabled="disabled" onclick="AuthService.login()">Login</button>
        <button id="logout" disabled="disabled" onclick="AuthService.logout()">Logout</button>
    </div>

</body>

<script>

    /**************************************************************************
     * 
     * App, services
     * 
    /**************************************************************************/
    const AppSettings = {
        appName: "authflow-test",
        authAPIHost: "", // the authentication gw host
        authResponseHandlerUrl: window.location.origin + window.location.pathname, // the url without query params etc
        generateAppContext() {
            return encodeURIComponent(btoa(JSON.stringify({ appName: this.appName, redirectUrl: this.authResponseHandlerUrl })));
        },
        validateAppSettings() {
            if (!this.authAPIHost) {
                const errorMessage = "AppSettings.authAPIHost is not defined";
                window.alert(errorMessage);
                throw new Error(errorMessage);
            }
        }
    }

    const log = function (context, message, ...args) {
        console.log(context, "->", message, ...args);
    }

    const AuthState = {
        isInTransition: false,
        user: {
            email: null,
        },
        login(token) {
            this.isInTransition = true;
            if (typeof token === "string") {
                log("AuthState", "logged in");
                localStorage.setItem("authToken", token);
            }
        },
        logout() {
            this.isInTransition = true;
            this.user.email = null;
            log("AuthState", "logged out");
            localStorage.removeItem("authToken");
        },
        isLoggedIn() {
            return this.getAuthToken() !== null;
        },
        isLoading() {
            return this.isInTransition || (this.isLoggedIn() && this.user.email === null);
        },
        getAuthToken() {
            return localStorage.getItem("authToken")
        },
        async handleLoggedIn() {
            try {
                this.user.email = await AuthService.fetchUserEmail(this.getAuthToken());
            } catch (error) {
                // Auth invalidated
                log("AuthState", "login invalidated");
                this.logout();
                UIState.resetViewState(); // reset view state
            }
        },
    }

    const AuthService = {
        login() {
            log("AuthService", "logging in..");
            AppSettings.validateAppSettings();
            UIState.transitToUrl(`${AppSettings.authAPIHost}/auth/openid/login-request?appContext=${AppSettings.generateAppContext()}`); // LoginRequest
        },
        async fetchAuthToken(loginCode) {
            const response = await fetch(`${AppSettings.authAPIHost}/auth/openid/auth-token-request`, { // AuthTokenRequest
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    loginCode: loginCode,
                    appContext: AppSettings.generateAppContext(),
                }),
            });

            const { token } = await response.json();
            return token
        },
        async fetchUserEmail(accessToken) {
            const response = await fetch(`${AppSettings.authAPIHost}/auth/openid/user-info-request`, { // UserInfoRequest
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    token: accessToken,
                    appContext: AppSettings.generateAppContext(),
                }),
            });
            if (response.status !== 200) {
                if (response.status === 401) {
                    throw new Error("Unauthorized");
                }
                throw new Error("Unknown error");
            }
            const { email } = await response.json();
            return email
        },
        logout() {
            log("AuthService", "logging out..");
            AppSettings.validateAppSettings();
            UIState.transitToUrl(`${AppSettings.authAPIHost}/auth/openid/logout-request?appContext=${AppSettings.generateAppContext()}`); // LogoutRequest
        },
    }

    /**************************************************************************
     * 
     * Event listeners
     * 
    /**************************************************************************/
    const LoginFlowEventsListener = async function () {
        const urlParams = new URLSearchParams(window.location.search);

        if (!AuthState.isLoggedIn()) {
            if (urlParams.has("loginCode")) {
                log("LoginFlowEventsListener", "Login code received, fetching auth token..");
                //
                // Handle login response
                //
                const loginCode = urlParams.get('loginCode');
                try {
                    const token = await AuthService.fetchAuthToken(loginCode);
                    AuthState.login(token); // Store token in local storage
                    await AuthState.handleLoggedIn(); // Fetch user info
                    UIState.resetViewState(); // reset view state
                } catch (error) {
                    log("LoginFlowEventsListener", "Failed to fetch auth token", error);
                }
            }
        } else if (urlParams.has("logout")) {
            log("LoginFlowEventsListener", "Logout event received, logging out");
            //
            // Handle logout response
            //
            const logoutResponse = urlParams.get('logout');
            if (logoutResponse === "success") {
                AuthState.logout();
                UIState.resetViewState(); // reset view state
            }
        } else {
            await AuthState.handleLoggedIn(); // Validate login
            UIState.handleCurrentState(); // Update UI
        }
    }

    const UIState = {
        handleCurrentState() {
            const loginButton = document.getElementById("login");
            const logoutButton = document.getElementById("logout");
            const loginState = document.getElementById("loginState");
            if (AuthState.isLoading()) {
                loginButton.disabled = true;
                logoutButton.disabled = true;
                loginState.innerText = "loading..";
            } else if (AuthState.isLoggedIn()) {
                loginButton.disabled = true;
                logoutButton.disabled = false;
                loginState.innerText = `logged in as ${AuthState.user.email}`;
            } else {
                loginButton.disabled = false;
                logoutButton.disabled = true;
                loginState.innerText = "logged out";
            }
        },
        flagTransition() {
            AuthState.isInTransition = true;
            this.handleCurrentState();
        },
        transitToUrl(url) {
            this.flagTransition();
            window.location.href = url;
        },
        resetViewState() {
            window.history.replaceState({}, document.title, window.location.pathname); // clear url params
            AuthState.isInTransition = false;
            this.handleCurrentState();
        },
    }


    /**************************************************************************
     * 
     * Execution
     * 
    /**************************************************************************/
    UIState.handleCurrentState();
    LoginFlowEventsListener();

</script>

</html>