<!DOCTYPE html>
<html>

<body>

    <h1>Virtual Finland Development</h1>

    <h2>Login flow examples / tests</h2>

    <div id="Sinuna">
        <div>
            <b>Sinuna login state:</b> <span class="loginState">...</span>
        </div>
        <hr>
        <div>
            <button class="login" disabled="disabled" onclick="sinuna.AuthService.login()">Login</button>
            <button class="logout" disabled="disabled" onclick="sinuna.AuthService.logout()">Logout</button>
        </div>
    </div>

    <div id="SuomiFI">
        <div>
            <b>Suomi.fi login state:</b> <span class="loginState">...</span>
        </div>
        <hr>
        <div>
            <button class="login" disabled="disabled" onclick="suomifi.AuthService.login()">Login</button>
            <button class="logout" disabled="disabled" onclick="suomifi.AuthService.logout()">Logout</button>
        </div>
    </div>

</body>

<script>

    /**************************************************************************
     * 
     * App, services
     * 
    /**************************************************************************/
    const AppSettings = {
        appName: "authflow-test",
        authAPIHost: "", // the authentication gw host
        authResponseHandlerUrl: window.location.origin + window.location.pathname, // the url without query params etc
        generateAppContext(provider) {
            return encodeURIComponent(btoa(JSON.stringify({ appName: this.appName, redirectUrl: this.authResponseHandlerUrl, provider: provider })));
        },
        validateAppSettings() {
            if (!this.authAPIHost) {
                const errorMessage = "AppSettings.authAPIHost is not defined";
                window.alert(errorMessage);
                throw new Error(errorMessage);
            }
        }
    }

    const log = function (context, message, ...args) {
        console.log(context, "->", message, ...args);
    }

    /**************************************************************************
     * 
     * Login service defs
     * 
    /**************************************************************************/
    class BaseAppComponent {
        parent = null;
        constructor(parent) {
            this.parent = parent;
            this.getName = this.parent.getName.bind(parent);
            this.log = this.parent.log.bind(parent);
            this.endpoints = this.parent.endpoints;
        }

        initialize() {
            this.UIState = this.parent.UIState;
            this.AuthState = this.parent.AuthState;
            this.AuthService = this.parent.AuthService;
        }
    }


    class BaseLoginApp {
        name = null;
        endpoints = {
            login: null,
            logout: null,
            userInfo: null,
            token: null,
        }

        constructor(configuration) {
            this.name = configuration.name;
            this.endpoints = configuration.endpoints;

            this.UIState = new UIState(this);
            this.AuthState = new AuthState(this);
            this.AuthService = new AuthService(this);
        }

        initialize() {
            this.UIState.initialize();
            this.AuthState.initialize();
            this.AuthService.initialize();
        }

        getName() {
            if (!this.name) {
                throw new Error("name is not defined");
            }
            return this.name;
        }

        log(...messages) {
            log(`[${this.getName()}]`, ...messages);
        }

        engage() {
            this.initialize();
            this.UIState.handleCurrentState();
            this.engageLoginFlowEventsListener();
        }

        /**************************************************************************
          * 
          * Event listeners
          * 
         /**************************************************************************/
        async engageLoginFlowEventsListener() {
            const urlParams = new URLSearchParams(window.location.search);

            if (!this.AuthState.isLoggedIn()) {
                if (urlParams.has("loginCode")) {
                    this.log("LoginFlowEventsListener", "Login code received, fetching auth token..");
                    //
                    // Handle login response
                    //
                    const loginCode = urlParams.get('loginCode');
                    try {
                        const token = await this.AuthService.fetchAuthToken(loginCode);
                        this.AuthState.login(token); // Store token in local storage
                        await this.AuthState.handleLoggedIn(); // Fetch user info
                        this.UIState.resetViewState(); // reset view state
                    } catch (error) {
                        this.log("LoginFlowEventsListener", "Failed to fetch auth token", error);
                    }
                }
            } else if (urlParams.has("logout")) {
                this.log("LoginFlowEventsListener", "Logout event received, logging out");
                //
                // Handle logout response
                //
                const logoutResponse = urlParams.get('logout');
                if (logoutResponse === "success") {
                    this.AuthState.logout();
                    this.UIState.resetViewState(); // reset view state
                }
            } else {
                await this.AuthState.handleLoggedIn(); // Validate login
                this.UIState.handleCurrentState(); // Update UI
            }
        }
    }

    class AuthService extends BaseAppComponent {
        login() {
            this.log("AuthService", "logging in..");
            AppSettings.validateAppSettings();
            this.UIState.transitToUrl(`${AppSettings.authAPIHost}/${this.endpoints.login}?appContext=${AppSettings.generateAppContext(this.getName())}`); // LoginRequest
        }
        async fetchAuthToken(loginCode) {
            if (typeof this.endpoints.token !== "string") {
                // No token endpoint defined, login code is the token
                return loginCode;
            }

            const response = await fetch(`${AppSettings.authAPIHost}/${this.endpoints.token}`, { // AuthTokenRequest
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    loginCode: loginCode,
                    appContext: AppSettings.generateAppContext(this.getName()),
                }),
            });

            const { token } = await response.json();
            return token
        }
        async fetchUserEmail(accessToken) {
            const response = await fetch(`${AppSettings.authAPIHost}/${this.endpoints.userInfo}`, { // UserInfoRequest
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    token: accessToken,
                    appContext: AppSettings.generateAppContext(this.getName()),
                }),
            });
            if (response.status !== 200) {
                if (response.status === 401) {
                    throw new Error("Unauthorized");
                }
                throw new Error("Unknown error");
            }
            const { email } = await response.json();
            return email
        }
        logout() {
            this.log("AuthService", "logging out..");
            AppSettings.validateAppSettings();
            this.UIState.transitToUrl(`${AppSettings.authAPIHost}/${this.endpoints.logout}?appContext=${AppSettings.generateAppContext(this.getName())}`); // LogoutRequest
        }
    }

    class AuthState extends BaseAppComponent {
        storeKey = null
        isInTransition = false
        user = {
            email: null,
        }

        constructor(loginApp) {
            super(loginApp);
            this.storeKey = `${AppSettings.appName}_${loginApp.getName()}_authState`;
        }

        login(token) {
            this.isInTransition = true;
            if (typeof token === "string") {
                this.log("AuthState", "logged in");
                localStorage.setItem(this.storeKey, token);
            }
        }
        logout() {
            this.isInTransition = true;
            this.user.email = null;
            this.log("AuthState", "logged out");
            localStorage.removeItem(this.storeKey);
        }
        isLoggedIn() {
            return this.getAuthToken() !== null;
        }
        isLoading() {
            return this.isInTransition || (this.isLoggedIn() && this.user.email === null);
        }
        getAuthToken() {
            return localStorage.getItem(this.storeKey)
        }
        async handleLoggedIn() {
            try {
                this.user.email = await this.AuthService.fetchUserEmail(this.getAuthToken());
            } catch (error) {
                // Auth invalidated
                this.log("AuthState", "login invalidated");
                this.logout();
                this.UIState.resetViewState(); // reset view state
            }
        }
    }

    class UIState extends BaseAppComponent {
        handleCurrentState() {
            const loginButton = document.querySelector(`#${this.getName()} .login`);
            const logoutButton = document.querySelector(`#${this.getName()} .logout`);
            const loginState = document.querySelector(`#${this.getName()} .loginState`);
            if (this.AuthState.isLoading()) {
                loginButton.disabled = true;
                logoutButton.disabled = true;
                loginState.innerText = "loading..";
            } else if (this.AuthState.isLoggedIn()) {
                loginButton.disabled = true;
                logoutButton.disabled = false;
                loginState.innerText = `logged in as ${this.AuthState.user.email}`;
            } else {
                loginButton.disabled = false;
                logoutButton.disabled = true;
                loginState.innerText = "logged out";
            }
        }
        flagTransition() {
            this.AuthState.isInTransition = true;
            this.handleCurrentState();
        }
        transitToUrl(url) {
            this.flagTransition();
            window.location.href = url;
        }
        resetViewState() {
            window.history.replaceState({}, document.title, window.location.pathname); // clear url params
            this.AuthState.isInTransition = false;
            this.handleCurrentState();
        }
    }

    /**************************************************************************
     * 
     * login services
     * 
    /**************************************************************************/
    const sinuna = new BaseLoginApp({
        name: "Sinuna",
        endpoints: {
            login: "/auth/openid/login-request",
            logout: "/auth/openid/logout-request",
            userInfo: "/auth/openid/user-info-request",
            token: "/auth/openid/auth-token-request"
        },
    });
    const suomifi = new BaseLoginApp({
        name: "SuomiFI",
        endpoints: {
            login: "/auth/saml2/login-request",
            logout: "/auth/saml2/logout-request",
            userInfo: "/auth/saml2/user-info-request",
        },
    });

    /**************************************************************************
     * 
     * Execution
     * 
    /**************************************************************************/
    sinuna.engage();
    suomifi.engage();
</script>

</html>