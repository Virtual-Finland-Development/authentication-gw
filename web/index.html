<!DOCTYPE html>
<html>

<body>

    <h1>Virtual Finland Development</h1>

    <h2>Login flow examples / tests</h2>

    <div id="sinuna">
        <div>
            <b>Sinuna login state:</b> <span class="loginState">...</span>
        </div>
        <hr>
        <div>
            <button class="login" disabled="disabled" onclick="Sinuna.AuthService.login()">Login</button>
            <button class="logout" disabled="disabled" onclick="Sinuna.AuthService.logout()">Logout</button>
        </div>
    </div>

</body>

<script>

    /**************************************************************************
     * 
     * App, services
     * 
    /**************************************************************************/
    const AppSettings = {
        appName: "authflow-test",
        authAPIHost: "", // the authentication gw host
        authResponseHandlerUrl: window.location.origin + window.location.pathname, // the url without query params etc
        generateAppContext() {
            return encodeURIComponent(btoa(JSON.stringify({ appName: this.appName, redirectUrl: this.authResponseHandlerUrl })));
        },
        validateAppSettings() {
            if (!this.authAPIHost) {
                const errorMessage = "AppSettings.authAPIHost is not defined";
                window.alert(errorMessage);
                throw new Error(errorMessage);
            }
        }
    }

    const log = function (context, message, ...args) {
        console.log(context, "->", message, ...args);
    }

    class Sinuna {
        static log(...messages) {
            log("Sinuna", ...messages);
        }

        static AuthState = {
            isInTransition: false,
            user: {
                email: null,
            },
            login(token) {
                this.isInTransition = true;
                if (typeof token === "string") {
                    Sinuna.log("AuthState", "logged in");
                    localStorage.setItem("authToken", token);
                }
            },
            logout() {
                this.isInTransition = true;
                this.user.email = null;
                Sinuna.log("AuthState", "logged out");
                localStorage.removeItem("authToken");
            },
            isLoggedIn() {
                return this.getAuthToken() !== null;
            },
            isLoading() {
                return this.isInTransition || (this.isLoggedIn() && this.user.email === null);
            },
            getAuthToken() {
                return localStorage.getItem("authToken")
            },
            async handleLoggedIn() {
                try {
                    this.user.email = await this.AuthService.fetchUserEmail(this.getAuthToken());
                } catch (error) {
                    // Auth invalidated
                    Sinuna.log("AuthState", "login invalidated");
                    Sinuna.logout();
                    Sinuna.UIState.resetViewState(); // reset view state
                }
            },
        }

        static AuthService = {
            login() {
                Sinuna.log("AuthService", "logging in..");
                AppSettings.validateAppSettings();
                Sinuna.UIState.transitToUrl(`${AppSettings.authAPIHost}/auth/openid/login-request?appContext=${AppSettings.generateAppContext()}`); // LoginRequest
            },
            async fetchAuthToken(loginCode) {
                const response = await fetch(`${AppSettings.authAPIHost}/auth/openid/auth-token-request`, { // AuthTokenRequest
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        loginCode: loginCode,
                        appContext: AppSettings.generateAppContext(),
                    }),
                });

                const { token } = await response.json();
                return token
            },
            async fetchUserEmail(accessToken) {
                const response = await fetch(`${AppSettings.authAPIHost}/auth/openid/user-info-request`, { // UserInfoRequest
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        token: accessToken,
                        appContext: AppSettings.generateAppContext(),
                    }),
                });
                if (response.status !== 200) {
                    if (response.status === 401) {
                        throw new Error("Unauthorized");
                    }
                    throw new Error("Unknown error");
                }
                const { email } = await response.json();
                return email
            },
            logout() {
                Sinuna.log("AuthService", "logging out..");
                AppSettings.validateAppSettings();
                Sinuna.UIState.transitToUrl(`${AppSettings.authAPIHost}/auth/openid/logout-request?appContext=${AppSettings.generateAppContext()}`); // LogoutRequest
            },
        }

        /**************************************************************************
         * 
         * Event listeners
         * 
        /**************************************************************************/
        static LoginFlowEventsListener = async function () {
            const urlParams = new URLSearchParams(window.location.search);

            if (!this.AuthState.isLoggedIn()) {
                if (urlParams.has("loginCode")) {
                    Sinuna.log("LoginFlowEventsListener", "Login code received, fetching auth token..");
                    //
                    // Handle login response
                    //
                    const loginCode = urlParams.get('loginCode');
                    try {
                        const token = await Sinuna.AuthService.fetchAuthToken(loginCode);
                        Sinuna.AuthState.login(token); // Store token in local storage
                        await Sinuna.AuthState.handleLoggedIn(); // Fetch user info
                        Sinuna.UIState.resetViewState(); // reset view state
                    } catch (error) {
                        Sinuna.log("LoginFlowEventsListener", "Failed to fetch auth token", error);
                    }
                }
            } else if (urlParams.has("logout")) {
                Sinuna.log("LoginFlowEventsListener", "Logout event received, logging out");
                //
                // Handle logout response
                //
                const logoutResponse = urlParams.get('logout');
                if (logoutResponse === "success") {
                    Sinuna.AuthState.logout();
                    Sinuna.UIState.resetViewState(); // reset view state
                }
            } else {
                await Sinuna.AuthState.handleLoggedIn(); // Validate login
                Sinuna.UIState.handleCurrentState(); // Update UI
            }
        }

        static UIState = {
            handleCurrentState() {
                const loginButton = document.querySelector("#sinuna .login");
                const logoutButton = document.querySelector("#sinuna .logout");
                const loginState = document.querySelector("#sinuna .loginState");
                if (Sinuna.AuthState.isLoading()) {
                    loginButton.disabled = true;
                    logoutButton.disabled = true;
                    loginState.innerText = "loading..";
                } else if (Sinuna.AuthState.isLoggedIn()) {
                    loginButton.disabled = true;
                    logoutButton.disabled = false;
                    loginState.innerText = `logged in as ${Sinuna.AuthState.user.email}`;
                } else {
                    loginButton.disabled = false;
                    logoutButton.disabled = true;
                    loginState.innerText = "logged out";
                }
            },
            flagTransition() {
                Sinuna.AuthState.isInTransition = true;
                this.handleCurrentState();
            },
            transitToUrl(url) {
                this.flagTransition();
                window.location.href = url;
            },
            resetViewState() {
                window.history.replaceState({}, document.title, window.location.pathname); // clear url params
                Sinuna.AuthState.isInTransition = false;
                this.handleCurrentState();
            },
        }
    }


    /**************************************************************************
     * 
     * Execution
     * 
    /**************************************************************************/
    Sinuna.UIState.handleCurrentState();
    Sinuna.LoginFlowEventsListener();

</script>

</html>